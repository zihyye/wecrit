<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WECRIT Service</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />

    <style>
        :root{
            --primary-color:#4A8CFF; --primary-dark:#366ED8; --primary-light:#EBF3FF;
            --bg-body:#F7F9FC; --surface-white:#FFFFFF; --surface-input:#F0F4F8;
            --text-main:#1A1A1A; --text-sub:#757575;
            --shadow-sm:0 4px 15px rgba(74,140,255,0.1);
            --shadow-md:0 10px 30px rgba(74,140,255,0.15);
            --radius-xl:24px; --radius-lg:16px;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:"Pretendard",'Noto Sans KR',sans-serif;background:var(--bg-body);color:var(--text-main);-webkit-font-smoothing:antialiased;}
        .app-container{width:100%;max-width:480px;margin:0 auto;background:var(--surface-white);min-height:100vh;display:flex;flex-direction:column;box-shadow:0 0 60px rgba(0,0,0,0.03);}
        .top-nav{position:sticky;top:0;height:64px;display:flex;align-items:center;padding:0 24px;background:rgba(255,255,255,0.85);backdrop-filter:blur(12px);border-bottom:1px solid rgba(0,0,0,0.03);z-index:100;}
        .back-arrow{font-size:22px;display:none;padding:8px;cursor:pointer;margin-left:-8px;}
        .nav-title{position:absolute;left:50%;transform:translateX(-50%);font-weight:700;display:none;}
        .page{display:none;flex-direction:column;align-items:center;width:100%;flex:1;padding:30px 24px;justify-content:center;}
        .page.active{display:flex;}
        .page.no-padding-top{padding-top:0;justify-content:flex-start;background:#FAFBFC;}
        .btn-common{background:linear-gradient(135deg,#4A8CFF 0%,#366ED8 100%);color:#fff;border:0;border-radius:16px;padding:18px 0;width:100%;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(74,140,255,0.3);}
        .post-list{width:100%;padding:24px 20px;display:flex;flex-direction:column;gap:24px;padding-bottom:100px;}
        .post-item{padding:0;cursor:pointer;border-radius:24px;overflow:hidden;background:#fff;transition:transform .2s,box-shadow .2s;position:relative;}
        .post-item.special-bg{box-shadow:var(--shadow-sm);border:1px solid rgba(255,255,255,1);}
        .image-row{display:flex;gap:2px;height:220px;overflow:hidden;}
        .image-row img{height:100%;object-fit:cover;display:block;transition:transform .5s;}
        .title-box{background:#fff;padding:24px;text-align:left;font-size:16px;font-weight:700;color:var(--text-main);line-height:1.4;}
        .empty-message{text-align:center;color:#999;margin-top:80px;font-size:15px;}
        .btn-delete{width:100%;padding:16px 0;background:var(--surface-white);color:#FF4B4B;border:2px solid #FF4B4B;border-radius:30px;font-size:16px;font-weight:700;cursor:pointer;display:none;margin-top:12px;}
    </style>
</head>
<body>

<div class="app-container">
    <nav class="top-nav">
        <span class="back-arrow" onclick="goBack()">&#10094;</span>
        <span class="nav-title" id="page-title">ìƒˆ ê²Œì‹œë¬¼</span>
    </nav>

    <section id="page-1" class="page active">
        <h1 style="font-size:48px;font-weight:900;color:var(--primary-color);text-align:center;line-height:1.1;margin-bottom:20px;">WELCOME<br>TO<br>WECRIT!</h1>
        <p style="text-align:center;color:var(--text-sub);margin-bottom:60px;">ê³¼ì œ ê³ ë¯¼,<br>í˜¼ì í•˜ê³  ê³„ì‹ ê°€ìš”?<br>ì´ì œëŠ” ê³„ì›ì¸ë“¤ì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!</p>
        <button class="btn-common" onclick="goToPage('page-2')">ì°¸ì—¬í•˜ê¸°</button>
    </section>

    <section id="page-2" class="page">
        <div style="width:80px;height:80px;border-radius:40px;background:var(--primary-light);display:flex;align-items:center;justify-content:center;margin-bottom:30px;font-size:32px;color:var(--primary-color);">ğŸ’¬</div>
        <h2 style="margin-bottom:40px;font-size:22px;font-weight:700;color:var(--text-main);">ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</h2>
        <div class="input-group" style="width:100%;margin-bottom:24px;">
            <label style="font-weight:700;color:var(--primary-dark);margin-bottom:10px;display:block;">ë‹‰ë„¤ì„</label>
            <input id="input-nickname" type="text" placeholder="ì˜ˆ: ì£¼í˜„" style="width:100%;height:56px;border-radius:16px;padding:0 20px;background:var(--surface-input);border:2px solid transparent;outline:none;font-size:16px;">
        </div>
        <div class="input-group" style="width:100%;margin-bottom:24px;">
            <label style="font-weight:700;color:var(--primary-dark);margin-bottom:10px;display:block;">í•™ ê³¼</label>
            <select id="input-major" style="width:100%;height:56px;border-radius:16px;padding:0 20px;background:var(--surface-input);border:2px solid transparent;outline:none;font-size:16px;">
                <option value="" disabled selected>ì„ íƒí•´ì£¼ì„¸ìš”</option>
                <option value="ê´‘ê³ Â·ë¸Œëœë“œë””ìì¸ê³¼">ê´‘ê³ Â·ë¸Œëœë“œë””ìì¸ê³¼</option>
                <option value="ê²Œì„ë¯¸ë””ì–´ê³¼">ê²Œì„ë¯¸ë””ì–´ê³¼</option>
                <option value="ê±´ì¶•ë””ìì¸ê³¼">ê±´ì¶•ë””ìì¸ê³¼</option>
                <option value="ë””ì§€í„¸ë¯¸ë””ì–´ë””ìì¸ê³¼">ë””ì§€í„¸ë¯¸ë””ì–´ë””ìì¸ê³¼</option>
                <option value="ì‹œê°ë””ìì¸ê³¼">ì‹œê°ë””ìì¸ê³¼</option>
            </select>
        </div>
        <button class="btn-common" onclick="submitUserInfo()">ë“± ë¡</button>
    </section>

    <section id="page-3" class="page">
        <h2 style="font-size:24px;font-weight:700;margin-bottom:16px;text-align:center;"> <span id="display-name">000</span>ë‹˜ ë°˜ê°€ì›Œìš”!ğŸ‘‹</h2>
        <p style="text-align:center;color:var(--text-sub);margin-bottom:50px;">ì§€ê¸ˆë¶€í„°,<br>ìœ„í¬ë¦¿ì—ì„œ ê³„ì›ì¸ë“¤ê³¼<br>í”¼ë“œë°±ì„ ì£¼ê³  ë°›ì•„ ë³´ì„¸ìš”!</p>
        <div style="width:100%;display:flex;flex-direction:column;gap:16px;">
            <button class="btn-common" onclick="goToPage('page-5')">í”¼ë“œë°± í•˜ëŸ¬ ê°€ê¸°</button>
            <button class="btn-common" style="background:#fff;color:var(--primary-color);border:2px solid var(--primary-color);box-shadow:none;" onclick="goToPage('page-8')">í”¼ë“œë°± ë°›ìœ¼ëŸ¬ ê°€ê¸°</button>
        </div>
    </section>

    <section id="page-5" class="page no-padding-top">
        <header style="width:100%;padding:0 10px;position:sticky;top:64px;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-bottom:1px solid rgba(0,0,0,0.04);z-index:10;display:flex;align-items:center;">
            <span style="font-size:22px;padding:10px;cursor:pointer;color:var(--text-main)" onclick="goBack()">&#10094;</span>
            <div style="flex:1;text-align:center;font-weight:800;color:var(--primary-color);">ì „ì²´ ê²Œì‹œë¬¼</div>
            <div style="width:60px"></div>
        </header>

        <div style="padding:20px 24px;background:#F0F7FF;color:var(--primary-color);font-size:14px;text-align:center;border-bottom:1px solid rgba(74,140,255,0.1);">ìœ„í¬ë¦¿ì€ ê³„ì›ì˜ˆìˆ ëŒ€í•™êµ í•™ìƒë“¤ì´ í¸í•˜ê²Œ í”¼ë“œë°±ì„ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆë„ë¡ ë§Œë“  ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.<br>ì°¸ê³ ìš©ìœ¼ë¡œ ì´ìš©í•´ ì£¼ì„¸ìš”!</div>

        <div class="post-list" id="post-list">
            <div class="empty-message">ë“±ë¡ëœ í”¼ë“œë°± ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ê²Œì‹œë¬¼ì„ ì˜¬ë ¤ë³´ì„¸ìš”!</div>
        </div>
    </section>

    <section id="page-7" class="page" style="display:none;">
        <!-- ê²°ê³¼/ëŒ“ê¸€ í˜ì´ì§€ (ê°„ëµí™”) -->
        <div style="width:100%;max-width:480px;">
            <h1 style="font-size:22px;font-weight:700;">íˆ¬í‘œ ê²°ê³¼</h1>
            <div id="comment-list" style="margin-top:20px;"></div>
            <button class="btn-delete" id="btn-delete-post" onclick="deleteCurrentPost()">ê²Œì‹œë¬¼ ì‚­ì œ</button>
        </div>
    </section>

    <section id="page-8" class="page" style="justify-content:flex-start;padding-top:20px;display:none;">
        <div id="imageWrapper" style="width:100%;overflow:auto;white-space:nowrap;margin-bottom:24px;"></div>
        <textarea id="feedbackTextarea" placeholder="ë°›ê³  ì‹¶ì€ í”¼ë“œë°±ì„ ì ì–´ì£¼ì„¸ìš”..." style="width:100%;min-height:140px;border-radius:16px;padding:20px;border:2px solid transparent;background:#F8F9FB;margin-bottom:30px;"></textarea>
        <button class="btn-common share-button" disabled>ê³µìœ í•˜ê¸°</button>
    </section>
</div>

<script>
/* SCRIPT_URL: ì„œë²„ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbymgWt3vCPuIme5vZmdXXxT8resrgrFN8YgpIDxpvwFMDS72XUQH2mJSHvp8gstg08hww/exec";

/* ì „ì—­ ìƒíƒœ */
let historyStack = [];
let currentUser = { nickname: "", major: "" };
let currentPostId = null;
let currentPostAuthor = null;
let allPostsData = [];
const voteCounts = {};

/* ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ìœ ì € ì •ë³´ ë¡œë“œ */
function loadUserInfo(){
    const nn = localStorage.getItem('userNickname');
    const mj = localStorage.getItem('userMajor');
    if(nn && mj){ currentUser.nickname = nn; currentUser.major = mj; document.getElementById('display-name').innerText = nn; return true; }
    return false;
}
function saveUserInfo(nickname, major){ localStorage.setItem('userNickname', nickname); localStorage.setItem('userMajor', major); }

/* SPA ì´ë™ */
function goToPage(pageId){
    const active = document.querySelector('.page.active');
    if(active && active.id !== pageId && active.id !== 'page-1') historyStack.push(active.id);
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const page = document.getElementById(pageId);
    if(page) page.classList.add('active');
    updateUI(pageId);
    window.scrollTo(0,0);
}
function goBack(){
    if(historyStack.length>0){
        const prev = historyStack.pop();
        goToPage(prev);
    } else {
        goToPage('page-3');
    }
}
function updateUI(pageId){
    const arrow = document.querySelector('.back-arrow');
    const title = document.getElementById('page-title');
    if(['page-6','page-7','page-8'].includes(pageId)) arrow.style.display = 'block'; else arrow.style.display = 'none';
    if(pageId==='page-8') title.style.display = 'block' ; else title.style.display = 'none';
}

/* ìœ í‹¸: ì´ë¯¸ì§€ ì†ŒìŠ¤ í•´ì„ (ë¬¸ìì—´ ë˜ëŠ” {data,mimeType} í˜•íƒœ í—ˆìš©) */
function resolveImageSrc(img){
    if(!img) return null;
    if(typeof img === 'string') return img;
    if(img.url) return img.url;
    if(img.data && img.mimeType) return `data:${img.mimeType};base64,${img.data}`;
    return null;
}

/* ê²Œì‹œë¬¼ ì—´ê¸° (íˆ¬í‘œ/ê²°ê³¼ í˜ì´ì§€) */
function openVotePage(postId, question, imgASrc, imgBSrc, authorNickname){
    // ì‚­ì œëœ ê²Œì‹œë¬¼ì€ ì—´ì§€ ì•ŠìŒ
    if(!allPostsData.some(p => p && p.id === postId)){
        alert('ì´ ê²Œì‹œë¬¼ì€ ì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        renderPosts('all');
        goToPage('page-5');
        return;
    }

    currentPostId = postId;
    currentPostAuthor = authorNickname || (allPostsData.find(p => p.id === postId) || {}).nickname || null;

    // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™ (ê°„ë‹¨íˆ ê²°ê³¼/ëŒ“ê¸€ í˜ì´ì§€ë¥¼ ë³´ì—¬ì£¼ê²Œ í•¨)
    loadComments(postId);
    // show delete button only for author
    const isAuthor = currentUser.nickname && currentPostAuthor && (currentUser.nickname === currentPostAuthor);
    const delBtn = document.getElementById('btn-delete-post');
    if(delBtn) delBtn.style.display = isAuthor ? 'block' : 'none';

    goToPage('page-7');
}

/* ëŒ“ê¸€ ë¡œë“œ (ê°„ë‹¨í•œ í˜•íƒœ) */
async function loadComments(postId){
    const commentList = document.getElementById('comment-list');
    if(!commentList) return;
    commentList.innerHTML = '<div style="color:#999;padding:12px;">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
    try{
        const res = await fetch(`${SCRIPT_URL}?action=getComments&postId=${postId}`);
        const comments = await res.json();
        if(!Array.isArray(comments) || comments.length===0){
            commentList.innerHTML = '<div style="color:#999;padding:12px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        commentList.innerHTML = '';
        comments.reverse().forEach(c=>{
            const div = document.createElement('div');
            div.className='comment-item';
            div.style.cssText='margin-bottom:12px;padding:12px;background:#fff;border-radius:12px;';
            div.innerHTML = `<div style="font-weight:700;color:#366ED8;">${c.nickname||'ìµëª…'} <span style="font-weight:400;color:#777;font-size:13px;">(${c.major||'ë¯¸ì„ íƒ'})</span></div><div style="color:#333;margin-top:8px;">${c.text||''}</div>`;
            commentList.appendChild(div);
        });
    }catch(e){
        commentList.innerHTML = '<div style="color:#999;padding:12px;">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        console.error('loadComments error', e);
    }
}

/* ê²Œì‹œë¬¼ ì¶”ê°€ - ìƒˆ ê²Œì‹œë¬¼ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¦‰ì‹œ ë³´ì´ê²Œ) */
function addNewPostToBoard(post){
    // post: {id, nickname, question, imgA, imgB, ...}
    // guard: ë¹ˆ ê²Œì‹œë¬¼ì€ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
    const srcA = resolveImageSrc(post.imgA);
    const srcB = resolveImageSrc(post.imgB);
    const hasContent = (post.question && post.question.toString().trim()) || srcA || srcB;
    if(!post || !post.id || !hasContent) return;

    // prepend to data and render
    allPostsData.unshift(post);
    // keep voteCounts
    voteCounts[post.id] = { A: parseInt(post.voteA)||0, B: parseInt(post.voteB)||0 };
    renderPosts('all');
}

/* ê³µìœ (ê°„ë‹¨ ì²˜ë¦¬) */
const shareButton = document.querySelector('.share-button');
const textarea = document.getElementById('feedbackTextarea');
if(textarea) textarea.addEventListener('input', ()=>{ /* no-op for now */ });

/* ì„œë²„ì—ì„œ ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸°, ë¹ˆ ë ˆì½”ë“œ ì œê±° */
async function loadPostsFromSheet(){
    try{
        const res = await fetch(SCRIPT_URL);
        const posts = await res.json();
        // Normalize: ensure array and filter out empty rows (no id or no content)
        if(!Array.isArray(posts)){
            allPostsData = [];
            renderPosts('all');
            return;
        }
        allPostsData = posts.filter(p=>{
            if(!p || !p.id) return false;
            const hasQuestion = p.question && p.question.toString().trim();
            const hasImageA = !!p.imgA;
            const hasImageB = !!p.imgB;
            return hasQuestion || hasImageA || hasImageB;
        });
        // Fill voteCounts safely
        allPostsData.forEach(p => {
            voteCounts[p.id] = { A: parseInt(p.voteA)||0, B: parseInt(p.voteB)||0 };
        });
        renderPosts('all');
    }catch(err){
        console.error('loadPostsFromSheet error', err);
    }
}

/* ê²Œì‹œë¬¼ ë Œë”ë§: í•­ìƒ ì „ì²´ ë¦¬ìŠ¤íŠ¸ë¥¼ í´ë¦° ë Œë”ë§ -> ì”ì—¬ ê³µë°± ë¬¸ì œ í•´ê²° */
function renderPosts(filterType){
    const list = document.getElementById('post-list');
    if(!list) return;
    list.innerHTML = '';

    let filtered = allPostsData.slice();
    if(filterType === 'my'){
        filtered = allPostsData.filter(p => p.nickname === currentUser.nickname);
    }

    // Filter again to avoid any empty entries
    filtered = filtered.filter(p => p && p.id && ((p.question && p.question.toString().trim()) || p.imgA || p.imgB));

    if(filtered.length === 0){
        list.innerHTML = '<div class="empty-message">ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    filtered.forEach(post => {
        addExistingPostToBoard(post);
    });
}

/* ê¸°ì¡´ ê²Œì‹œë¬¼ ìš”ì†Œ ìƒì„± (ì™„ì „í•œ article ìš”ì†Œ, data-post-id í¬í•¨) */
function addExistingPostToBoard(post){
    if(!post || !post.id) return;
    // guard against empty posts
    const srcA = resolveImageSrc(post.imgA);
    const srcB = resolveImageSrc(post.imgB);
    const hasContent = (post.question && post.question.toString().trim()) || srcA || srcB;
    if(!hasContent) return;

    const list = document.getElementById('post-list');
    const article = document.createElement('article');
    article.className = 'post-item special-bg';
    article.setAttribute('data-post-id', post.id);
    if(post.nickname) article.dataset.author = post.nickname;

    // Build images html safely (no broken img tags)
    let imagesHtml = '';
    if(srcA && srcB){
        imagesHtml = `<img src="${srcA}" class="w-50" style="width:50%;height:100%;object-fit:cover;" onerror="this.style.display='none'"><img src="${srcB}" class="w-50" style="width:50%;height:100%;object-fit:cover;" onerror="this.style.display='none'>`;
    } else if(srcA){
        imagesHtml = `<img src="${srcA}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'>`;
    } else if(srcB){
        imagesHtml = `<img src="${srcB}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'>`;
    }

    const questionText = post.question ? String(post.question) : '';

    article.innerHTML = `<div class="image-row" style="background:transparent;">${imagesHtml}</div><div class="title-box gray-box">${escapeHtml(questionText)}</div>`;

    // Click opens vote/result page
    article.addEventListener('click', () => openVotePage(post.id, questionText, post.imgA, post.imgB, post.nickname));

    list.appendChild(article);
}

/* ê²Œì‹œë¬¼ ì‚­ì œ: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì™„ì „ ì œê±° -> ëª©ë¡ì„ í´ë¦° ë Œë”ë§ */
function deleteCurrentPost(){
    if(!currentPostId){
        alert('ì‚­ì œí•  ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    if(!confirm('ì •ë§ ì´ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë‚´ìš©ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

    const idToDelete = currentPostId;

    // 1) í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°”ë¡œ ì œê±° (ë‚™ê´€ì )
    try{
        // remove from data
        allPostsData = allPostsData.filter(p => p && p.id !== idToDelete);

        // clear vote counts and local storage flag
        if(voteCounts[idToDelete]) delete voteCounts[idToDelete];
        localStorage.removeItem('voted_' + idToDelete);

        // re-render the list completely (this eliminates any leftover blank cards)
        renderPosts('all');

        // reset UI areas related to the deleted post
        const commentList = document.getElementById('comment-list');
        if(commentList) commentList.innerHTML = '';
        currentPostId = null;
        currentPostAuthor = null;

        // ensure we are on the list page
        goToPage('page-5');
    }catch(e){
        console.warn('Client-side delete error:', e);
    }

    // 2) ì„œë²„ì— ì‚­ì œ ìš”ì²­ (ë¹„ë™ê¸°)
    fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action:'delete', id: idToDelete })
    })
    .then(res => res.json())
    .then(data => {
        if(!data || data.result !== 'success'){
            // ì„œë²„ ì‚­ì œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œë§Œ ì•Œë¦¬ë˜, í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” ì´ë¯¸ ì œê±°í–ˆìœ¼ë¯€ë¡œ ë³µì›í•˜ì§€ ì•ŠìŒ
            console.warn('Server delete failed:', data && data.message);
            alert('ì„œë²„ì—ì„œ ê²Œì‹œë¬¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (í•˜ì§€ë§Œ í™”ë©´ì—ì„œëŠ” ì‚­ì œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.)');
        }
    })
    .catch(err => {
        console.error('Delete request error:', err);
        alert('ì‚­ì œ ìš”ì²­ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (í™”ë©´ì—ì„œëŠ” ì‚­ì œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.)');
    });
}

/* ìœ í‹¸: ì•ˆì „í•œ HTML ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì§€ ìµœì†Œ) */
function escapeHtml(str){
    if(!str) return '';
    return String(str).replace(/[&<>"']/g, function(m){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
}

/* ì‚¬ìš©ì ë“±ë¡ */
function submitUserInfo(){
    const nickname = document.getElementById('input-nickname').value.trim();
    const major = document.getElementById('input-major').value;
    if(!nickname){ alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
    if(!major){ alert('í•™ê³¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
    currentUser.nickname = nickname; currentUser.major = major;
    saveUserInfo(nickname, major);
    document.getElementById('display-name').innerText = nickname;
    goToPage('page-3');
}

/* ì´ˆê¸°í™”: ë¡œë“œ í›„ ìƒíƒœ ë°˜ì˜ */
window.addEventListener('DOMContentLoaded', () => {
    if(loadUserInfo()) goToPage('page-3');
    loadPostsFromSheet();
});
</script>

</body>
</html>
